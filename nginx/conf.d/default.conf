server {
    listen 80;
    server_name localhost;

    # 1. 前端 (Vue) 設定
    location / {
        root /var/www/frontend;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    # 2. 圖片儲存 (Storage)
    location /storage/ {
        alias /var/www/html/storage/app/public/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 3. Laravel API (修正後的設定)
    location /api {
        # 設定 API 的根目錄
        alias /var/www/html/public;

        # 嘗試尋找檔案，如果找不到，就強制轉給 @laravel 處理
        try_files $uri $uri/ @laravel;
    }

    # 4. PHP 處理核心 (Named Location)
    location @laravel {
        # 這裡不設 root，直接指定 SCRIPT_FILENAME
        fastcgi_pass api:9000;
        include fastcgi_params;

        # 強制指定執行 Laravel 的入口檔案
        fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
        fastcgi_param QUERY_STRING $query_string;

        # 修正 Path Info 傳遞，讓 Laravel 讀懂 /api/waste/upload
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # 禁止訪問隱藏檔
    location ~ /\. {
        deny all;
    }
}